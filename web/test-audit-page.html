<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        button:hover { background: #0056b3; }
        #auditForm {
            margin: 20px 0;
        }
        input[type="url"] {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
        }
    </style>
</head>
<body>
    <h1>üîß Audit System Test Page</h1>
    
    <div class="test-section">
        <h2>üìä System Status</h2>
        <div id="systemStatus">
            <div class="info">Loading system status...</div>
        </div>
    </div>

    <div class="test-section">
        <h2>üåê Network Connectivity Test</h2>
        <button onclick="testConnectivity()">Test Connectivity</button>
        <div id="connectivityResults"></div>
    </div>

    <div class="test-section">
        <h2>üöÄ Audit Functionality Test</h2>
        <form id="auditForm">
            <label for="testUrl">Test URL:</label>
            <input type="url" id="testUrl" placeholder="https://example.com" value="https://httpbin.org">
            <button type="submit">Start Test Audit</button>
        </form>
        <div id="auditResults"></div>
    </div>

    <div class="test-section">
        <h2>üìã Recent Activity</h2>
        <div id="activityLog"></div>
    </div>

    <script>
        // Check system status
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/notifications/badge');
                if (response.ok) {
                    document.getElementById('systemStatus').innerHTML = 
                        '<div class="success">‚úÖ Server is responding normally</div>';
                } else {
                    document.getElementById('systemStatus').innerHTML = 
                        '<div class="error">‚ùå Server returned status: ' + response.status + '</div>';
                }
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = 
                    '<div class="error">‚ùå Server connection failed: ' + error.message + '</div>';
            }
        }

        // Test network connectivity
        async function testConnectivity() {
            const resultsDiv = document.getElementById('connectivityResults');
            resultsDiv.innerHTML = '<div class="info">Testing connectivity...</div>';
            
            const testUrls = [
                'https://httpbin.org/get',
                'https://www.google.com',
                'https://github.com',
                'https://example.com'
            ];
            
            const results = [];
            
            for (const url of testUrls) {
                try {
                    const startTime = Date.now();
                    const response = await fetch(`/test-connectivity?url=${encodeURIComponent(url)}`);
                    const duration = Date.now() - startTime;
                    
                    if (response.ok) {
                        results.push(`<div class="success">‚úÖ ${url} - ${duration}ms</div>`);
                    } else {
                        results.push(`<div class="error">‚ùå ${url} - Status: ${response.status}</div>`);
                    }
                } catch (error) {
                    results.push(`<div class="error">‚ùå ${url} - Error: ${error.message}</div>`);
                }
            }
            
            resultsDiv.innerHTML = results.join('');
        }

        // Handle audit form submission
        document.getElementById('auditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const testUrl = document.getElementById('testUrl').value;
            const resultsDiv = document.getElementById('auditResults');
            
            if (!testUrl) {
                resultsDiv.innerHTML = '<div class="error">‚ùå Please enter a URL to test</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="info">üöÄ Starting audit test...</div>';
            
            try {
                // Submit audit request
                const formData = new FormData();
                formData.append('url', testUrl);
                
                const response = await fetch('/audit/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.redirected) {
                    resultsDiv.innerHTML = '<div class="info">üìä Audit started, monitoring progress...</div>';
                    
                    // Extract session ID from redirect URL
                    const redirectUrl = response.url;
                    const sessionMatch = redirectUrl.match(/session[Id]*[=/]([^&?]+)/);
                    
                    if (sessionMatch) {
                        const sessionId = sessionMatch[1];
                        monitorAuditProgress(sessionId);
                    } else {
                        resultsDiv.innerHTML = '<div class="error">‚ùå Could not extract session ID from response</div>';
                    }
                } else {
                    const responseText = await response.text();
                    resultsDiv.innerHTML = `<div class="error">‚ùå Unexpected response: ${response.status}</div>`;
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Audit request failed: ${error.message}</div>`;
            }
        });
        
        // Monitor audit progress
        function monitorAuditProgress(sessionId) {
            const resultsDiv = document.getElementById('auditResults');
            
            const eventSource = new EventSource(`/audit/progress/${sessionId}`);
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    switch (data.type) {
                        case 'connected':
                            resultsDiv.innerHTML += '<div class="info">üîå Connected to progress stream</div>';
                            break;
                        case 'progress':
                            resultsDiv.innerHTML += `<div class="info">‚è±Ô∏è Progress: ${data.status}</div>`;
                            break;
                        case 'completed':
                            resultsDiv.innerHTML += '<div class="success">‚úÖ Audit completed successfully!</div>';
                            resultsDiv.innerHTML += `<div class="info">üìä <a href="${data.redirectUrl}" target="_blank">View Results</a></div>`;
                            eventSource.close();
                            break;
                        case 'error':
                            resultsDiv.innerHTML += `<div class="error">‚ùå Audit failed: ${data.message}</div>`;
                            eventSource.close();
                            break;
                    }
                } catch (error) {
                    resultsDiv.innerHTML += `<div class="error">‚ùå Error parsing progress data: ${error.message}</div>`;
                }
            };
            
            eventSource.onerror = function(event) {
                resultsDiv.innerHTML += '<div class="error">‚ùå Progress stream connection failed</div>';
                eventSource.close();
            };
            
            // Auto-close after 2 minutes
            setTimeout(() => {
                if (eventSource.readyState !== EventSource.CLOSED) {
                    eventSource.close();
                    resultsDiv.innerHTML += '<div class="info">‚è∞ Progress monitoring timed out</div>';
                }
            }, 120000);
        }
        
        // Log activity
        function logActivity(message) {
            const logDiv = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML = `<div class="info">[${timestamp}] ${message}</div>` + logDiv.innerHTML;
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            checkSystemStatus();
            logActivity('Test page loaded');
        });
    </script>
</body>
</html>
